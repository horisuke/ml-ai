### AWS Lambda実践ガイド
#### 1. Lambdaで実現するサーバレスシステム

##### 1-1. 管理の手間を削減しコスト削減を実現するLambda
* AWS環境でアプリケーションを構築する場合、プログラム実行環境として仮想サーバEC2インスタンスを用意し、その環境で動かすのが一般的だが、その運用には手間もコストもかかる。

###### 1-1-1. EC2インスタンスの運用上の問題
* EC2インスタンスは単純な仮想サーバであり、OSやプログラム実行環境、フレームワーク、ライブラリなどをインストールしてプログラムの実行環境を整える必要があるが、これらの実行環境構築は手間がかかる。
* 加えて運用も管理も大変である。インストールしたものに脆弱性が見つかれば、その脆弱性をふさぐためのアップデートをする必要がある。
* EC2には性能の問題もある。EC2はインスタンス起動時に選んだインスタンスタイプによって性能が決まる。インスタンスを一時停止すればインスタンスタイプを変更することはできるが、インスタンスが稼働している間は固定となる。
* そのため、急激な負荷増に耐えられないことがある。負荷に耐えるためには負荷を予測して適切なインスタンスタイプで起動しておいたり、負荷分散機能であるELB(Elastic Load Balancing)と負荷に応じてインスタンスの数を自動的に変更できるAuto Scalingの仕組みを組み合わせて、動的にインスタンス数を増減できる構成をとる、といった工夫が必要となる。
* こうしたEC2の運用の手間を軽減する方法の1つがLambdaである。

###### 1-1-2. アップロードした関数を実行してくれるLambda
* Lambdaはサーバレスアーキテクチャと呼ばれ、実行環境としてEC2のような仮想サーバは不要。
* 実行環境はAWSによって実行のたびに用意されるため、サーバシステムの保守・運用も不要。
* 負荷が高まれば、自動的にスケールするため、負荷増の場合の対応を考える必要もない(ただし、スケールできる同時実行数に制限はある)。
* Lambdaでプログラムを実行するためには実行したいプログラムを関数として実装し、Lambdaにアップロードするだけでよい。
* 実行する際に実行環境(コンテナ)が自動で作られ、プログラムが実行される。

###### 1-1-3. Lambdaの制限
* LambdaはEC2の完全置き換えにはならず、いくつか制限がある。
* ステートレス
    * Lambda関数は都度実行され、実行が終わると破棄される。前回実行時の状態などの保持はできない。
* 最大稼働時間は5分
    * Lambda関数は最大稼働時間を設定でき、最大5分。それ以上時間がかかる処理を実行することはできない。
* これらの制限を踏まえると、継続的に稼働する処理ではなく、必要に応じて少しだけ動く処理にLambdaは向いている。
* 継続的に稼働する処理は従来通り、EC2インスタンスの方が適している。

###### 1-1-4. 開発者に優しいLambda
* Lambdaは実行環境がAWSによって用意されるため、開発者は実行したい機能を関数として作り、それをアップロードするだけでよい。
* Lambdaを使ってシステムを作る場合、多くのLambda関数を作り、それを組み合わせて使う、という運用になる。
* 1つ1つのプログラムが小さく、それぞれが独立しているので、テストも容易になる。
* Lambda関数同士の結合にはAmazon SQSやAmazon SNSトピックを使用することで、関数を疎結合にすることも可能。

###### 1-1-5. Lambdaはコスト削減にも貢献する
* Lambdaの課金単位は実行時間。実行されていないときは費用がかからない。
* 例えば、「毎日0時にバッチを3分程度実行したい」とする。
* これをEC2インスタンスで構築する場合、インスタンスを起動したままにしておき、0時になったらプログラムを実行するよう、cronなどを設定しておくことになる。
* つまりEC2は24時間稼働し、実行されていることになる。
* 一方、Lambdaの場合、Lambda関数をアップロードして、0時に動かすというスケジューリングを設定しておくだけでよい。
* 実行時間が3分なら、3分間の実行コストしかかからないため、うまくLambdaで構成することで大幅なコスト削減を実現できる。

###### 1-1-6. Lambdaが利用できるリージョン
* Lambdaは主要なほとんどのリージョンで対応しているが、Lambdaとともに利用するサービスの中にはリージョンによってサポートされていないものもある。

##### 1-2. イベントドリブンの糊付けプログラミング
* Lambda関数は決まったスケジュールで動かすこともできるが、それ以外にAWSの様々なサービスと連携したタイミングで実行できる。

###### 1-2-1. Lambda関数を稼働させるイベントリソース
* Lambda関数はAWS上のサービスと連携して実行することができる。
* 実行のトリガーになるものをイベントソースと呼ぶ。
* 例えばストレージサービスであるAmazon S3は「ファイルが置かれたとき」などにLambda関数を呼び出すことができる。
* これを利用すれば、「画像ファイルがアップロードされたときにサムネイルを作る」とか「ファイルがアップロードされたときにパスワード付きの暗号化zipを作る」という処理が実現できる。
* 加えてAPI Gatewayと組み合わせると、Lambda関数をREST形式のWebAPIとして呼び出すことが可能となる。
* これを利用することで、HTMLの入力フォームでPOSTしたり、JavaScriptのAjaxで通信した結果をLambda関数で処理し、データベースに保存するといった処理もできる。

###### 1-2-2. LambdaはAWSのサービスをつなぎ合わせる
* Lambda関数は「AWSのサービスから呼び出され、何かの処理をして別のAWSサービスを実行する」という処理の構成になることがほとんどである。
* よって、Lambdaプログラミングのほとんどは様々なAWSサービスを糊付けするために使われる。そのため、どのようなAWSサービスがあり、どのように利用するものかという知識も不可欠になってくる。

##### 1-3. まとめ
* 上記まででLambdaを利用するメリット、またLambdaでは実現できないことがあることを説明。
* 最大の難関はLambdaにおけるプログラミングを習得する必要があるという点である。
* EC2インスタンス上で動くプログラムはオンプレミス環境の延長上であり、様々な従来の開発技術がそのまま使用できたが、LambdaはAWSが用意した実行環境上で動くため、様々な作法をLambdaに合わせる必要がある。
* よって、プログラミング技法はAWSに固有のものとなり、習得コストがかかる。
* ただLambdaは小さなプログラムを組み合わせてシステム全体を作る、という思想なので、1つ1つのプログラム規模は小さく、それほど難しくはない。小さなプログラムで十分な処理が可能である。

#### 2. Lambda事始め

##### 2-1. サンプル用Lambda関数の仕様
* AWSマネージメントコンソールを使って簡単なLambda関数を作る。
* Lambda関数のサンプル例として、「x」、「y」を引数として渡すと、その値をログに出力し、「x÷y」の計算結果を戻り値として返すものを考える。
* 引数は以下のようなJSON形式で渡すものとする。
   ```
   {"x" : 10, "y" : 2}
   ```
* 戻り値も以下のようなJSON形式で返るものとする。
   ```
   {"result" : 5}
   ```
* また、このとき受け取った引数 $x$, $y$ の値をCloudWatch Logsにログ出力するようにする。
* loudWatch Logsはログデータを使用してアプリケーションとシステムをモニタリングするAWSのサービスの1つ。

##### 2-2. Lambda関数の構造と設計
* Lambda関数を作るには関数の引数、戻り値の書式、エラーの返し方などLambda関数の基本的な決まりごとの理解が必要となる。
* 以下、Python3でプログラムを作成する。
###### 2-2-1. Lambda関数の書式
* Lambda関数はS3やSESなどで発生するイベントをトリガーにして呼び出され、Lambda関数は適切な実行環境の中で実行される。
* これらの実行環境の情報はコンテキストと呼ばれる。
* Lambda関数が実行される場合、イベント情報とコンテキスト情報が渡される。
* Python3の場合、下記のように「event」、「context」の2つの引数を取る書式で定義する。
   ```
   def myfunc_handler(event, context):
       ・・・関数の処理・・・
       return 戻り値
   ```
* Lambda関数はハンドラとも呼ばれ、慣例的に関数は「機能名_handler」とされることが多い。
* イベント引数はイベントから渡される任意の入力値である。渡ってくるデータ自体はJSON形式の文字列だが、Lambda関数に引数で渡される時点ではparseされ、関数の言語で扱いやすい形になっている。
* 例えば、以下のようなJSONがイベントから渡ってくるとする。
   ```
   {"x" : 10, "y" : 2}
   ```
* myfunc_handlerの引数eventには開発言語であるPython3に合わせ、event["x"], event["y"]として、それぞれ10, 2が取得できる。
* コンテキスト引数はコンテキスト(実行環境)の情報が含まれるオブジェクトである。
* 以下のような様々な環境情報を取得できる。
* Contextオブジェクトのメソッド：
    |Method|意味|
    |---|---|
    |get_remaining_time_in_millis()|実行可能な残時間(ミリ秒)を取得する|
* Contextオブジェクトのプロパティ：
    |Property|意味|
    |---|---|
    |function_name|Lambda関数の名前|
    |function_version|Lambda関数のバージョン|
    |invokcd_function_arn|Lambda関数の呼び出しに使われたARN|
    |memory_limit_in_mb|コンテキストに割り当てられているメモリ(MB)|
    |aws_request_id|リクエストに関連付けられたリクエストID|
    |log_group_name|CloudWatch Logsのロググループ名|
    |log_stream_name|CloudWatch Logsのログストリーム名|
    |identity|AWS Mobile SDK経由で呼び出された場合のCognito認証プロバイダに関する情報|
    |client_context|AWS Mobile SDK経由で呼び出された場合のクライアントアプリケーションの情報|
* 戻り値はPythonのreturn文を使って設定する。イベントの種類によっては戻り値が無視されることもある。
* Lambda関数からprint文などで標準出力した内容は全てCloudWatch Logsに書き出される。

###### 2-2-2. Lambda関数のサンプル
* プログラムの仕様
    * イベント引数として{"x":xの値, "y":yの値}を与えると、そのxとyをprintで出力し、「x÷y」の結果を{"result":答え}の形で返す。
* サンプルプログラム
    ```python
    import json

    def myfunc01_handler(event, context):
        x = int(event['x'])
        y = int(event['y'])
        print("x = " + str(x))
        print("y = " + str(y))
        retval = {'result' : x / y}
        return json.dumps(retval)
    ```
   * まず渡されたeventからｘとｙの値を取得する。JSON文字列として受け取るが、関数内ではすでにparseされているので、x, yの値はそれぞれ、```event['x']```, ```event['y']```で取得できる。
   * 「x÷y」を計算するために```int()```メソッドで文字列から整数に変換し、それぞれx, yに格納する。
   * それらの値は```print()```メソッドで標準出力に書き出すことでCloudWatch Logsに書き込まれる。
   * 最後に```json.dump()```メソッドでJSON文字列に変換して戻り値を設定する。

##### 2-3. Lambdaの利用に必要なアクセス権
* AWSマネージメントコンソールでLambda関数を作る前に必要なIAM(Identify and Access Management)ユーザとIAMロールを作成しておく必要がある。

###### 2-3-1. IAMユーザとIAMロール
* AWSアカウント作成時のメールアドレスとパスワードはルートアカウント(管理者アカウント)の認証情報である。
* この認証情報でサインインした場合、AWS全てのリソースにアクセスできるため、通常利用は推奨されていない。
* 通常、IAMユーザというアカウントを利用する。
* IAMユーザはAWSリソースに対するユーザ認証と用途ごとに細かいリソースへのアクセス権限を適用できる。
* ここではLambda関数を作成・実行・操作するためのIAMユーザを用意する。
* IAMロールはAWSリソースへのアクセス権限のことで、管理者がロールにアクセス権限を付与し、そのロールをIAMユーザに適用する。
* これにより、IAMユーザはAWSのリソースに適切にアクセスできるようになる。
* また、Lambda関数(AWSリソース)にロールを適用することで、Lambda関数から適切にAWSサービスやリソースにアクセスできるようになる。
* IAMユーザにはアクセスポリシーを付与する。アクセスポリシーには各種権限が含まれている。
* Lambda関数にはIAMロールを付与する。IAMロールはアクセスポリシーを付与することで作成する。同様にアクセスポリシーには各種権限が含まれている。

###### 2-3-2. Lambdaの利用に必要なアクセス権
* Lambdaを利用する場合、以下の3つのアクセス権が関与する。
* Lambda関数の作成権限：開発者用のIAMユーザの権限
    * 開発者はAWSマネジメントコンソールやAWS CLIなどを用い、AWS上にLambda関数を作成する権限「lambda:CreateFunction」が必要である。
    * この権限がない開発者はLambda関数が作成できない。
* Lambda関数の実行権限：開発者用のIAMユーザやイベント元の権限
    * Lambda関数を実行する権限は「lambda:InvokeFunction」であり、開発者が主導でLambda関数を実行する場合、開発者にこの権限が必要となる。
* Lambda関数からの操作権限：Lambda関数の権限
    * Lambda関数はログをCloudWatchLogsへ書き込むため、最低限CloudWatchLogsへの書き込み権限が必要。
    * 具体的には「logs:PutLogEvents」、「logs:CreateLogStream」、「logs:CreateLogGroup」の権限が必要。
    * Lambda関数にて、例えばS3を操作したり、DynampDBを操作したりする場合は、それぞれリソースへのアクセス権が必要となる。

###### 2-3-3. 既存の管理ポリシーを適用する
* これらのアクセス権をひとつずつ設定するのは煩雑なため、アクセス権の設定は通常、既存のアクセスポリシーを適用する。
* 既存のアクセスポリシーを適用するのは、大雑把な感じがあるが、簡単にIAMユーザやIAMロールを構成できる。
* 開発者が手動で実行するLambda関数を作る場合、以下のように構成する。
    * 開発者に割り当てるIAMユーザ
        * 通常、「AWSLambdaFullAccess」ポリシーを適用する。
        * このポリシーの適用により、Lambda関数を作成・実行が可能となる。
        * また、このポリシーにはLambda関数と一緒に使うことの多い、DynamoDBやS3などへの書き込み権限も付与されている。
    * Lambda関数に割り当てるIAMロール
        * 通常、「AWSLambdaBasicExecutionRole」ポリシーを適用する。
        * このポリシーの適用により、Lambda関数にCloudWatchLogsへの書き込みアクセス権(「logs:PutLogEvents」、「logs:CreateLogStream」、「logs:CreateLogGroup」)が付与される。

###### 2-3-4. IAMユーザとIAMロールを作成する
* 開発者のIAMユーザ(「AWSLambdaFullAccess」を適用したIAMユーザ)を作成
    * AWSコンソールにログインし、"サービス"からIAM(Identity and Access Management)を選択。
    * "ユーザー"タブを選択し、ユーザー一覧を表示する。"ユーザーを追加"ボタンを選択。
* Lambdaの実行ロールを作成
    * 「AWSLambdaBasicExecutionRole」を適用したIAMロールを作成する。
    * 作成するロール名は「role-lambdaexec」とする。
    * ★Appendix B

##### 2-4. Lambda関数の作成
* aa







#### 3.
